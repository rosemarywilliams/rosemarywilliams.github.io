<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gallery Manager | Rosemary Williams</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,600;1,400&family=Montserrat:wght@300;400;500&display=swap" rel="stylesheet">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
	  tailwind.config = {
	    theme: {
	      extend: {
	        fontFamily: {
	          sans: ['Montserrat', 'sans-serif'],
	          serif: ['Cormorant Garamond', 'serif'],
	        },
	        colors: {
	          cream: '#fcfbf9',
	          paper: '#f2efea',
	          gold: '#d4af37',
	          charcoal: '#2c2c2c',
	        },
	      },
	    },
	  }
    </script>
    <style>
        /* Mini Frame Previews for the Selector */
        .preview-frame-1 { border: 8px solid #eec; outline: 1px solid #000; }
        .preview-frame-2 { border: 8px solid #2c2c2c; outline: 1px solid #000; }
        .preview-frame-3 { border: 8px solid #d4af37; outline: 1px solid #000; }
        .preview-frame-4 { border: 8px solid #5a4a42; outline: 1px solid #000; }
    </style>
</head>
<body class="bg-paper text-gray-800 font-sans antialiased min-h-screen">

    <!-- DASHBOARD -->
    <div id="dashboard" class="transition-opacity duration-1000 ease-in-out">
        
        <!-- Navbar -->
        <nav class="bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center sticky top-0 z-40 shadow-sm">
            <div class="font-serif text-xl font-bold text-charcoal">Gallery Manager</div>
            <div class="flex gap-4 items-center">
                <div id="save-status" class="text-xs font-bold text-gold uppercase tracking-widest opacity-0 transition-opacity">Saved</div>
                <a href="art.html" target="_blank" class="text-xs uppercase tracking-widest text-gold hover:text-charcoal transition-colors">View Gallery â†—</a>
            </div>
        </nav>

        <main class="max-w-7xl mx-auto py-12 px-6 flex flex-col md:flex-row gap-12">
            
            <!-- EDITOR COLUMN (Left) -->
            <div class="w-full md:w-1/3 order-2 md:order-1">
                <div class="bg-white p-8 shadow-sm rounded-sm sticky top-24">
                    <h2 class="font-serif text-2xl text-charcoal mb-6 flex justify-between items-center">
                        <span id="form-title">New Art Piece</span>
                        <button id="reset-form" class="text-xs text-gray-400 uppercase tracking-wider hover:text-gold hidden">Cancel Edit</button>
                    </h2>
                    
                    <form id="art-form" class="space-y-6">
                        <input type="hidden" id="art-id">
                        
                        <!-- Title -->
                        <div>
                            <label class="block text-xs uppercase tracking-widest text-gray-500 mb-2">Title</label>
                            <input type="text" id="title" required placeholder="e.g. The Quiet Morning"
                                class="w-full bg-cream border border-gray-200 p-3 font-serif text-lg focus:outline-none focus:border-gold">
                        </div>
                        
                        <!-- Image Upload -->
                        <div>
                            <label class="block text-xs uppercase tracking-widest text-gray-500 mb-2">Artwork Image</label>
                            
                            <!-- Hidden input to store the actual Base64 string or URL -->
                            <input type="hidden" id="src">
                            
                            <div class="border-2 border-dashed border-gray-300 p-6 text-center cursor-pointer hover:bg-cream transition-colors relative" id="drop-zone">
                                <input type="file" id="image-upload" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
                                <div id="upload-placeholder">
                                    <svg class="w-8 h-8 mx-auto text-gray-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                                    <span class="text-xs text-gray-500 uppercase tracking-widest block">Upload Image</span>
                                </div>
                                <img id="preview-image" class="max-h-48 mx-auto hidden shadow-md" />
                            </div>
                             <p class="text-[10px] text-gray-400 mt-2">Click to upload from computer.</p>
                        </div>
                        
                        <!-- Frame Selector -->
                        <div>
                            <label class="block text-xs uppercase tracking-widest text-gray-500 mb-2">Frame Style</label>
                            <div class="grid grid-cols-4 gap-2">
                                <label class="cursor-pointer">
                                    <input type="radio" name="frame" value="frame-1" class="peer sr-only" checked>
                                    <div class="h-12 w-full bg-gray-100 preview-frame-1 peer-checked:ring-2 peer-checked:ring-gold transition-all"></div>
                                    <div class="text-[10px] text-center mt-1 text-gray-400">Classic</div>
                                </label>
                                <label class="cursor-pointer">
                                    <input type="radio" name="frame" value="frame-2" class="peer sr-only">
                                    <div class="h-12 w-full bg-gray-100 preview-frame-2 peer-checked:ring-2 peer-checked:ring-gold transition-all"></div>
                                    <div class="text-[10px] text-center mt-1 text-gray-400">Dark</div>
                                </label>
                                <label class="cursor-pointer">
                                    <input type="radio" name="frame" value="frame-3" class="peer sr-only">
                                    <div class="h-12 w-full bg-gray-100 preview-frame-3 peer-checked:ring-2 peer-checked:ring-gold transition-all"></div>
                                    <div class="text-[10px] text-center mt-1 text-gray-400">Gold</div>
                                </label>
                                <label class="cursor-pointer">
                                    <input type="radio" name="frame" value="frame-4" class="peer sr-only">
                                    <div class="h-12 w-full bg-gray-100 preview-frame-4 peer-checked:ring-2 peer-checked:ring-gold transition-all"></div>
                                    <div class="text-[10px] text-center mt-1 text-gray-400">Wood</div>
                                </label>
                            </div>
                        </div>

                        <!-- Wall Position (Y-Offset) -->
                        <div>
                            <label class="block text-xs uppercase tracking-widest text-gray-500 mb-2">Wall Position (Height)</label>
                            <select id="yOffset" class="w-full bg-cream border border-gray-200 p-3 text-sm focus:outline-none focus:border-gold">
                                <option value="-translate-y-32">Very High</option>
                                <option value="-translate-y-24">High</option>
                                <option value="-translate-y-12">Mid-High</option>
                                <option value="translate-y-0" selected>Center</option>
                                <option value="translate-y-12">Mid-Low</option>
                                <option value="translate-y-24">Low</option>
                                <option value="translate-y-32">Very Low</option>
                                <option value="translate-y-40">Lowest</option>
                            </select>
                        </div>

                        <!-- Visibility -->
                        <div class="flex items-center gap-3 pt-2">
                             <input type="checkbox" id="hidden" class="w-4 h-4 accent-gold">
                             <label for="hidden" class="text-sm text-gray-600">Hide from Gallery</label>
                        </div>
                        
                        <div class="pt-4">
                            <button type="submit" id="save-btn" class="w-full bg-charcoal text-white py-4 text-xs uppercase tracking-[0.2em] hover:bg-gold transition-colors duration-300">
                                Save Art Piece
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- LIST COLUMN (Right) -->
            <div class="w-full md:w-2/3 order-1 md:order-2">
                <div class="bg-white p-8 shadow-sm rounded-sm">
                    <h2 class="font-serif text-2xl text-charcoal mb-6">Current Collection</h2>
                    
                    <div id="loading-spinner" class="text-center py-10 text-gray-400 italic">Loading gallery...</div>
                    <div id="art-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- Items injected here -->
                    </div>
                    
                </div>
            </div>

        </main>
    </div>

    <script>
        // --- API CONFIGURATION ---
        const API_URL = "/api/art";
        const LOCAL_STORAGE_KEY = "rosemary_art_data";
        
        // DEFAULT DATA (Fallback)
        const DEFAULT_ART = [
            { id: 1, title: "The First Morning", src: "images/art/img17.png", frame: "frame-1", yOffset: "-translate-y-12" },
            { id: 2, title: "Study in Blue", src: "images/art/img12.png", frame: "frame-2", yOffset: "translate-y-20" },
            { id: 3, title: "Valley Silence", src: "images/art/img3.png", frame: "frame-3", yOffset: "-translate-y-8" },
            { id: 4, title: "Gold Study", src: "images/art/img18.png", frame: "frame-4", yOffset: "translate-y-32" },
            { id: 5, title: "Tall Shadows", src: "images/art/img9.png", frame: "frame-1", yOffset: "-translate-y-24" },
            { id: 6, title: "Winter Light", src: "images/art/img14.png", frame: "frame-1", yOffset: "translate-y-12" },
            { id: 7, title: "Small Joy", src: "images/art/img1.png", frame: "frame-3", yOffset: "translate-y-40" },
            { id: 8, title: "Abstract Study V", src: "images/art/img19.png", frame: "frame-4", yOffset: "-translate-y-20" }
        ];

        // --- DOM ELEMENTS ---
        const artForm = document.getElementById('art-form');
        const artList = document.getElementById('art-list');
        const formTitle = document.getElementById('form-title');
        const resetFormBtn = document.getElementById('reset-form');
        const saveStatus = document.getElementById('save-status');
        const loadingSpinner = document.getElementById('loading-spinner');
        const saveBtn = document.getElementById('save-btn');
        
        // Image Upload Elements
        const imageUpload = document.getElementById('image-upload');
        const srcInput = document.getElementById('src');
        const previewImage = document.getElementById('preview-image');
        const uploadPlaceholder = document.getElementById('upload-placeholder');

        // --- STATE ---
        let artCollection = [];
        let useLocalStorage = false; // Will flip to true if API fails

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            loadArt();
        });

        // --- IMAGE HANDLING ---
        imageUpload.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(evt) {
                    const result = evt.target.result;
                    srcInput.value = result; // Store Base64 string
                    
                    // Update UI
                    previewImage.src = result;
                    previewImage.classList.remove('hidden');
                    uploadPlaceholder.classList.add('hidden');
                };
                reader.readAsDataURL(file);
            }
        });

        function resetImagePreview() {
            imageUpload.value = '';
            previewImage.src = '';
            previewImage.classList.add('hidden');
            uploadPlaceholder.classList.remove('hidden');
        }

        // --- API / STORAGE OPERATIONS ---
        
        async function loadArt() {
            try {
                // Try Local Storage First (Prioritize local changes if API isn't working perfectly or if user is local)
                const localData = localStorage.getItem(LOCAL_STORAGE_KEY);
                
                if (localData) {
                    artCollection = JSON.parse(localData);
                    useLocalStorage = true;
                } else {
                    // Try Fetching from Cloudflare
                    try {
                        const response = await fetch(API_URL);
                        if (response.ok) {
                            const json = await response.json();
                            if(Array.isArray(json) && json.length > 0) {
                                artCollection = json;
                            } else {
                                artCollection = DEFAULT_ART;
                            }
                        } else {
                            throw new Error("API not okay");
                        }
                    } catch (apiErr) {
                        console.log("API unavailable, defaulting to basic set.");
                        artCollection = DEFAULT_ART;
                        useLocalStorage = true;
                    }
                }
            } catch (e) {
                artCollection = DEFAULT_ART;
                useLocalStorage = true;
            } finally {
                loadingSpinner.style.display = 'none';
                renderList();
            }
        }

        async function persistArt() {
            saveBtn.textContent = "Saving...";
            saveBtn.disabled = true;
            
            // 1. Save to Local Storage (Always do this as backup/speed)
            try {
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(artCollection));
            } catch (e) {
                if (e.name === 'QuotaExceededError') {
                    alert("Storage limit exceeded! Try uploading smaller images.");
                    saveBtn.textContent = "Save Art Piece";
                    saveBtn.disabled = false;
                    return;
                }
            }

            // 2. Try Save to API if we haven't determined we are local-only
            if (!useLocalStorage) {
                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        body: JSON.stringify(artCollection),
                        headers: { 'Content-Type': 'application/json' }
                    });
                    
                    if (!response.ok) {
                        console.warn("Could not save to Cloud. Saved locally only.");
                        useLocalStorage = true; // Fallback for future
                    }
                } catch (e) {
                    console.warn("Could not save to Cloud. Saved locally only.");
                    useLocalStorage = true;
                }
            }
            
            showSaveStatus();
            saveBtn.textContent = "Save Art Piece";
            saveBtn.disabled = false;
        }

        function showSaveStatus() {
            saveStatus.classList.remove('opacity-0');
            setTimeout(() => saveStatus.classList.add('opacity-0'), 2000);
        }

        function saveArt(artPiece) {
            const existingIndex = artCollection.findIndex(p => p.id === artPiece.id);
            
            if (existingIndex >= 0) {
                // Update
                artCollection[existingIndex] = { ...artCollection[existingIndex], ...artPiece };
            } else {
                // Create
                artCollection.push(artPiece);
            }
            
            renderList();
            persistArt();
            resetForm();
        }

        function deleteArt(id) {
            if(confirm('Delete this artwork? This cannot be undone.')) {
                artCollection = artCollection.filter(p => p.id !== id);
                renderList();
                persistArt();
                resetForm();
            }
        }

        function editArt(id) {
            const art = artCollection.find(p => p.id === id);
            if (!art) return;

            document.getElementById('art-id').value = art.id;
            document.getElementById('title').value = art.title;
            document.getElementById('src').value = art.src; // Keep original src
            document.getElementById('yOffset').value = art.yOffset || "translate-y-0";
            document.getElementById('hidden').checked = art.hidden || false;
            
            // Handle Image Preview
            if (art.src) {
                previewImage.src = art.src;
                previewImage.classList.remove('hidden');
                uploadPlaceholder.classList.add('hidden');
            } else {
                resetImagePreview();
            }

            // Radio button selection
            const radios = document.getElementsByName('frame');
            for(const radio of radios) {
                if(radio.value === (art.frame || 'frame-1')) {
                    radio.checked = true;
                }
            }
            
            formTitle.textContent = "Edit Art Piece";
            resetFormBtn.classList.remove('hidden');
            
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function resetForm() {
            artForm.reset();
            document.getElementById('art-id').value = '';
            document.getElementById('src').value = '';
            resetImagePreview();
            
            // Reset frame to 1
            document.getElementsByName('frame')[0].checked = true;
            document.getElementById('yOffset').value = "translate-y-0";
            
            formTitle.textContent = "New Art Piece";
            resetFormBtn.classList.add('hidden');
        }

        // --- EVENT LISTENERS ---

        artForm.addEventListener('submit', (e) => {
            e.preventDefault();
            
            const idInput = document.getElementById('art-id').value;
            const id = idInput ? parseInt(idInput) : Date.now();
            
            // Get selected frame
            let selectedFrame = 'frame-1';
            document.getElementsByName('frame').forEach(r => {
                if(r.checked) selectedFrame = r.value;
            });

            const newArt = {
                id: id,
                title: document.getElementById('title').value,
                src: document.getElementById('src').value, // This comes from file reader or previous value
                frame: selectedFrame,
                yOffset: document.getElementById('yOffset').value,
                hidden: document.getElementById('hidden').checked
            };
            
            if (!newArt.src) {
                alert("Please upload an image.");
                return;
            }
            
            saveArt(newArt);
        });

        resetFormBtn.addEventListener('click', (e) => {
            e.preventDefault();
            resetForm();
        });

        // --- RENDERING ---

        function renderList() {
            artList.innerHTML = '';

            // Render items
            artCollection.forEach(art => {
                const item = document.createElement('div');
                item.className = `border border-gray-100 p-4 rounded bg-white relative group ${art.hidden ? 'opacity-50' : ''}`;
                
                // Determine frame border color for thumbnail based on selection
                let borderColor = '#eec';
                if(art.frame === 'frame-2') borderColor = '#2c2c2c';
                if(art.frame === 'frame-3') borderColor = '#d4af37';
                if(art.frame === 'frame-4') borderColor = '#5a4a42';

                item.innerHTML = `
                    <div class="aspect-square w-full bg-gray-100 mb-3 relative overflow-hidden flex items-center justify-center">
                        <img src="${art.src}" class="w-24 h-24 object-cover shadow-lg" style="border: 4px solid ${borderColor};" onerror="this.src='https://via.placeholder.com/150?text=Error'">
                        ${art.hidden ? '<div class="absolute inset-0 bg-white/60 flex items-center justify-center text-xs font-bold text-gray-400 uppercase tracking-widest">Hidden</div>' : ''}
                    </div>
                    
                    <h3 class="font-serif text-lg text-charcoal font-semibold truncate">${art.title}</h3>
                    
                    <div class="flex gap-2 justify-end mt-2">
                        <button onclick="editArt(${art.id})" class="px-3 py-1 text-[10px] uppercase tracking-wider border border-gold text-gold hover:bg-gold hover:text-white transition-colors">Edit</button>
                        <button onclick="deleteArt(${art.id})" class="px-3 py-1 text-[10px] uppercase tracking-wider text-gray-400 hover:text-red-500 transition-colors">Delete</button>
                    </div>
                `;
                
                artList.appendChild(item);
            });
        }

    </script>
</body>
</html>